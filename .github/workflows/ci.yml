name: Terraform CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  terraform-validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Install zip
        run: sudo apt-get update -y && sudo apt-get install -y zip

      - name: Ensure lambda zip exists (for validate)
        run: |
          if [ -f bedrock_asset_processor.zip ]; then
            echo "Zip already present"
          else
            echo "placeholder" > /tmp/placeholder.txt
            zip -j bedrock_asset_processor.zip /tmp/placeholder.txt
          fi

      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive

      - name: Terraform init (no backend)
        run: terraform init -backend=false
        working-directory: terraform

      - name: Terraform validate
        run: terraform validate
        working-directory: terraform
